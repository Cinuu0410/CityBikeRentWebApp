<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wypożyczalnia rowerów miejskich</title>
    <link rel="stylesheet" th:href="@{/css/my_rents.css}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
<header>
    <div class="top-bar">
        <button type="button" class="btn btn-secondary menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-bars"></i> Menu
        </button>
        <h1>
            <span th:if="${loggedInUser}" th:text="${'Witaj, ' + loggedInUser.firstName + ' ' + loggedInUser.lastName + '!'}"></span>
        </h1>
        <div class="auth-buttons">
            <span th:if="${loggedInUser}">
                <div class="wallet-info">
                    Portfel: <span th:text="${walletBalance}"></span> PLN
                </div>
                <button type="button" class="btn btn-secondary logout-button" onclick="logout()">Wyloguj</button>
            </span>
            <span th:unless="${loggedInUser}">
                <button type="button" class="btn btn-secondary register-button" onclick="redirectToRegister()">Rejestracja</button>
                <span class="spacing"></span>
                <button type="button" class="btn btn-secondary login-button" onclick="redirectToLogin()">Logowanie</button>
            </span>
        </div>
    </div>
</header>

<div class="toolbar-menu">
    <div class="toolbar">
        <div class="toolbar-top"></div>
    </div>

    <nav class="side-menu">
        <button type="button" class="btn btn-secondary menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-times"></i> Zamknij
        </button>
        <a href="/main_page_citybikerent">Strona główna</a>
        <a href="/offer">Oferta</a>
        <span th:if="${loggedInUser}">
            <a href="/wallet">Portfel</a>
        </span>
        <a href="/price_list">Cennik</a>
        <a href="/contact">Kontakt</a>
        <a href="/rent">Rezerwacje</a>
        <span th:if="${loggedInUser}">
            <a href="/my_rents">Moje rezerwacje</a>
        </span>
        <a href="/regulations">Regulamin</a>
        <a href="/about_us">O nas</a>
    </nav>
</div>

<div class="toolbar-login">
    <div class="toolbar">
        <div class="toolbar-top"></div>
    </div>
</div>

<div class="container mt-4" th:if="${loggedInUser}">
    <div class="rental-info">
        <h2>Aktualne wypożyczenie</h2>
        <div th:if="${rentedBike}" class="bike-details">
            <p>Numer roweru: <span id="bikeNumber" th:text="${rentedBike.number}"></span></p>
            <p>Marka: <span th:text="${rentedBike.brand}"></span></p>
            <div class="buttons">
                <button type="button" id="returnBikeButton" class="btn btn-primary">Zwróć rower</button>
                <button type="button" id="reportIssueButton" class="btn btn-danger" onclick="reportIssue()">Zgłoś problem</button>
            </div>
        </div>
        <div th:unless="${rentedBike}" class="no-rental">
            <p>Aktualnie nie posiadasz wypożyczonego roweru.</p>
        </div>
    </div>
</div>

<footer>
    <p>2024 City Bike Rent &copy;</p>
</footer>

<script>
    function toggleMenu() {
        var sideMenu = document.querySelector('.side-menu');
        sideMenu.classList.toggle('open');
    }

    function redirectToLogin() {
        window.location.href = "/login";
    }
    function redirectToRegister() {
        window.location.href = "/register";
    }
    function logout() {
        window.location.href = "/logout";
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('returnBikeButton').onclick = returnBike;
        document.getElementById('reportIssueButton').onclick = reportIssue;
    });

    function returnBike() {
        var bikeNumberElement = document.getElementById("bikeNumber");
        var bikeNumber = bikeNumberElement.textContent || bikeNumberElement.innerText;

        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        alert("Rower został zwrócony.");
                        window.location.reload();
                    } else {
                        alert("Wystąpił błąd podczas zwrotu roweru: " + response.message);
                    }
                } else {
                    alert("Wystąpił błąd podczas zwrotu roweru. Spróbuj ponownie później.");
                    console.error("Błąd żądania AJAX:", xhr.status);
                }
            }
        };

        xhr.open("POST", "/return_bike");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify({ bikeNumber: bikeNumber }));
    }

    function reportIssue() {
        console.log("reportIssue function called");

        var bikeNumberElement = document.getElementById("bikeNumber");
        var bikeNumber = bikeNumberElement.textContent || bikeNumberElement.innerText;
        console.log("Bike number:", bikeNumber);

        var issueDescription = prompt("Podaj opis problemu:");
        console.log("Issue description:", issueDescription);

        if (issueDescription) {
            console.log("Sending AJAX request to report issue");

            fetch("/report_issue", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ bikeNumber: bikeNumber, issueDescription: issueDescription })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("AJAX request succeeded:", data);
                    alert("Zgłoszenie zostało wysłane");
                })
                .catch(error => {
                    console.error("AJAX request failed:", error);
                    alert("Zgłoszenie zostało wysłane");
                });
        } else {
            console.log("Issue description is empty, no request sent");
        }
    }
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
